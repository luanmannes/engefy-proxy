<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Engefy - Descoberta de APIs v3</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&family=Bebas+Neue&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root { --yellow: #FFD23F; --black: #1a1a1a; --dark: #2a2a2a; --medium: #3a3a3a; --light: #e0e0e0; --white: #fff; --green: #00d084; --orange: #ff9500; --red: #ff3b30; --blue: #007aff; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Poppins', sans-serif; background: var(--black); color: var(--white); min-height: 100vh; }
        .header { background: linear-gradient(135deg, var(--dark), var(--medium)); border-bottom: 3px solid var(--yellow); padding: 30px 40px; }
        .header h1 { font-family: 'Bebas Neue', sans-serif; font-size: 2.5rem; color: var(--yellow); letter-spacing: 3px; }
        .header p { color: var(--light); margin-top: 5px; font-size: 0.9rem; }
        .container { max-width: 1200px; margin: 0 auto; padding: 30px 40px; }
        .section { background: var(--dark); border: 2px solid var(--medium); border-radius: 12px; margin-bottom: 25px; overflow: hidden; }
        .section-header { display: flex; justify-content: space-between; align-items: center; padding: 20px 25px; border-bottom: 2px solid var(--medium); background: rgba(255,210,63,0.05); flex-wrap: wrap; gap: 10px; }
        .section-title { font-family: 'Bebas Neue', sans-serif; font-size: 1.5rem; color: var(--yellow); letter-spacing: 2px; }
        .section-body { padding: 20px 25px; }
        .btn { font-family: 'Poppins', sans-serif; padding: 10px 24px; border: 2px solid var(--yellow); background: transparent; color: var(--yellow); border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 0.85rem; transition: all 0.3s; }
        .btn:hover { background: var(--yellow); color: var(--black); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn.running { background: var(--yellow); color: var(--black); animation: pulse 1.5s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
        .log { font-family: 'JetBrains Mono', monospace; font-size: 0.78rem; background: var(--black); border: 1px solid var(--medium); border-radius: 8px; padding: 15px; max-height: 600px; overflow-y: auto; line-height: 1.8; white-space: pre-wrap; word-break: break-all; }
        .log::-webkit-scrollbar { width: 6px; }
        .log::-webkit-scrollbar-thumb { background: var(--yellow); border-radius: 10px; }
        .log .ok { color: var(--green); }
        .log .warn { color: var(--orange); }
        .log .err { color: var(--red); }
        .log .info { color: var(--blue); }
        .log .title { color: var(--yellow); font-weight: 700; font-size: 0.85rem; }
        .log .dim { color: #666; }
        .copy-btn { font-family: 'Poppins', sans-serif; padding: 14px 30px; border: none; background: var(--yellow); color: var(--black); border-radius: 8px; cursor: pointer; font-weight: 700; font-size: 0.95rem; width: 100%; transition: all 0.3s; margin-top: 20px; }
        .copy-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(255,210,63,0.4); }
        .instructions { background: rgba(255,210,63,0.08); border: 1px solid rgba(255,210,63,0.3); border-radius: 8px; padding: 15px 20px; margin-bottom: 20px; font-size: 0.85rem; line-height: 1.7; color: var(--light); }
        .instructions strong { color: var(--yellow); }
        .status-bar { display: flex; gap: 20px; margin-bottom: 20px; flex-wrap: wrap; }
        .status-item { display: flex; align-items: center; gap: 8px; font-size: 0.85rem; }
        .dot { width: 10px; height: 10px; border-radius: 50%; background: var(--medium); }
        .dot.ok { background: var(--green); }
        .dot.fail { background: var(--red); }
        .dot.pending { background: var(--orange); animation: pulse 1.5s infinite; }
        #reportOutput { display: none; }
    </style>
</head>
<body>
    <div class="header">
        <h1>üîç ENGEFY ‚Äî DESCOBERTA DE APIs v3</h1>
        <p>Scan do Pipefy (corrigido) + Sienge via proxy Netlify</p>
    </div>
    <div class="container">
        <div class="instructions">
            <strong>Instru√ß√µes:</strong><br>
            1. Clique em <strong>"Escanear Pipefy"</strong> para mapear todos os pipes<br>
            2. Clique em <strong>"Escanear Sienge"</strong> via proxy<br>
            3. Clique em <strong>"Copiar Relat√≥rio"</strong> e cole na conversa com o Claude
        </div>
        <div class="status-bar">
            <div class="status-item"><span class="dot" id="dotPipefy"></span><span>Pipefy</span></div>
            <div class="status-item"><span class="dot" id="dotSienge"></span><span>Sienge</span></div>
        </div>
        <div class="section">
            <div class="section-header">
                <span class="section-title">üìã PIPEFY ‚Äî DESCOBERTA DE PIPES</span>
                <button class="btn" id="btnPipefy" onclick="scanPipefy()">‚ñ∂ Escanear Pipefy</button>
            </div>
            <div class="section-body">
                <div class="log" id="logPipefy">Aguardando scan...</div>
            </div>
        </div>
        <div class="section">
            <div class="section-header">
                <span class="section-title">üèóÔ∏è SIENGE ‚Äî DESCOBERTA VIA PROXY</span>
                <button class="btn" id="btnSienge" onclick="scanSienge()">‚ñ∂ Escanear Sienge</button>
            </div>
            <div class="section-body">
                <div class="log" id="logSienge">Aguardando scan...</div>
            </div>
        </div>
        <div id="reportOutput" class="section">
            <div class="section-header">
                <span class="section-title">üìÑ RELAT√ìRIO PARA O CLAUDE</span>
            </div>
            <div class="section-body">
                <div class="log" id="reportText" style="max-height: 400px;"></div>
                <button class="copy-btn" onclick="copyReport()">üìã COPIAR RELAT√ìRIO COMPLETO</button>
            </div>
        </div>
    </div>

<script>
const PIPEFY_TOKEN = 'eyJhbGciOiJIUzUxMiJ9.eyJpc3MiOiJQaXBlZnkiLCJpYXQiOjE3NzA4MTY5OTYsImp0aSI6ImUyZWVlMjUxLTgzYzItNGU3ZC04OTFkLTBkZDZhNzM1ZjJhZCIsInN1YiI6MjQxNzA4LCJ1c2VyIjp7ImlkIjoyNDE3MDgsImVtYWlsIjoibHVhbm1hbm5lc0Bjb25zdHJ1dG9yYWVuZ2VmeS5jb20uYnIifSwidXNlcl90eXBlIjoiYXV0aGVudGljYXRlZCJ9.hSHH8ph-26_kViEdMZrrKj7tPrEvioADVdATYuFo0c_nb3ffD8G-luzd0luiAvDkPBQolawdS009s2PCVBpHcw';
const PROXY_BASE = '/.netlify/functions/sienge-proxy';
let pipefyReport = null;
let siengeReport = null;

// ===== PIPEFY =====
function logP(msg, cls = '') {
    const el = document.getElementById('logPipefy');
    el.innerHTML += `<span class="${cls}">${msg}</span>\n`;
    el.scrollTop = el.scrollHeight;
}

async function gql(query) {
    const res = await fetch('https://api.pipefy.com/graphql', {
        method: 'POST',
        headers: { 'Authorization': `Bearer ${PIPEFY_TOKEN}`, 'Content-Type': 'application/json' },
        body: JSON.stringify({ query })
    });
    return await res.json();
}

async function scanPipefy() {
    const btn = document.getElementById('btnPipefy');
    const dot = document.getElementById('dotPipefy');
    btn.disabled = true; btn.className = 'btn running'; btn.textContent = '‚è≥ Escaneando...';
    dot.className = 'dot pending';
    document.getElementById('logPipefy').innerHTML = '';

    try {
        logP('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'title');
        logP('  ESCANEANDO PIPEFY', 'title');
        logP('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'title');
        logP('');

        // 1. Buscar info do user
        logP('üîë Consultando usu√°rio...', 'info');
        const meData = await gql(`{ me { id name email } }`);
        if (meData.errors) throw new Error(JSON.stringify(meData.errors));
        const me = meData.data.me;
        logP(`‚úÖ ${me.name} (${me.email})`, 'ok');

        // 2. Usar o pipe conhecido (734128) para descobrir o org ID
        logP('\nüîç Descobrindo organiza√ß√£o via pipe 734128...', 'info');
        const pipeOrgData = await gql(`{ pipe(id: 734128) { id name organization { id name } } }`);
        if (pipeOrgData.errors) throw new Error(JSON.stringify(pipeOrgData.errors));
        const orgId = pipeOrgData.data.pipe.organization.id;
        const orgName = pipeOrgData.data.pipe.organization.name;
        logP(`‚úÖ Organiza√ß√£o: ${orgName} (ID: ${orgId})`, 'ok');

        // 3. Listar todos os pipes da organiza√ß√£o
        logP('\nüìã Buscando todos os pipes da organiza√ß√£o...', 'info');
        const orgData = await gql(`{
            organization(id: ${orgId}) {
                pipes {
                    id
                    name
                    cards_count
                    members_count
                    phases { id name cards_count }
                    start_form_fields { id label type }
                }
            }
        }`);

        if (orgData.errors) throw new Error(JSON.stringify(orgData.errors));
        const pipes = orgData.data.organization.pipes;
        logP(`‚úÖ ${pipes.length} pipes encontrados!`, 'ok');

        const allPipes = [];

        for (const pipe of pipes) {
            logP(`\n‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ`, 'dim');
            logP(`üìå "${pipe.name}" [ID: ${pipe.id}]`, 'title');
            logP(`   Cards: ${pipe.cards_count} | Membros: ${pipe.members_count}`, '');

            if (pipe.phases && pipe.phases.length > 0) {
                logP(`   üìÇ Fases:`, '');
                pipe.phases.forEach(p => logP(`      ‚Ä¢ ${p.name} (${p.cards_count} cards) [${p.id}]`, 'dim'));
            }

            if (pipe.start_form_fields && pipe.start_form_fields.length > 0) {
                logP(`   üìù Campos Formul√°rio:`, '');
                pipe.start_form_fields.forEach(f => logP(`      ‚Ä¢ "${f.label}" [${f.type}] [${f.id}]`, 'dim'));
            }

            // Buscar campos das fases + amostra de 1 card
            let phaseFields = {};
            let sampleFields = [];

            try {
                const detail = await gql(`{
                    pipe(id: ${pipe.id}) {
                        phases {
                            name
                            fields { id label type }
                            cards(first: 1) {
                                edges {
                                    node {
                                        title
                                        fields { name value field { id } }
                                    }
                                }
                            }
                        }
                    }
                }`);

                if (detail.data && detail.data.pipe) {
                    detail.data.pipe.phases.forEach(phase => {
                        if (phase.fields && phase.fields.length > 0) {
                            phaseFields[phase.name] = phase.fields;
                        }
                        if (phase.cards && phase.cards.edges.length > 0) {
                            phase.cards.edges[0].node.fields.forEach(f => {
                                if (!sampleFields.find(sf => sf.name === f.name)) {
                                    sampleFields.push(f);
                                }
                            });
                        }
                    });

                    for (const [pname, fields] of Object.entries(phaseFields)) {
                        logP(`   üè∑Ô∏è Campos fase "${pname}":`, '');
                        fields.forEach(f => logP(`      ‚Ä¢ "${f.label}" [${f.type}] [${f.id}]`, 'dim'));
                    }

                    if (sampleFields.length > 0) {
                        logP(`   üìä Amostra (1¬∫ card):`, '');
                        sampleFields.forEach(f => {
                            const v = f.value ? (f.value.length > 80 ? f.value.substring(0, 80) + '...' : f.value) : '(vazio)';
                            logP(`      ‚Ä¢ "${f.name}" = "${v}"`, 'dim');
                        });
                    }
                }
            } catch (e) {
                logP(`   ‚ö†Ô∏è Erro detalhes: ${e.message}`, 'warn');
            }

            allPipes.push({
                id: pipe.id, name: pipe.name,
                cards_count: pipe.cards_count,
                members_count: pipe.members_count,
                phases: pipe.phases,
                start_form_fields: pipe.start_form_fields,
                _phaseFields: phaseFields,
                _sampleFields: sampleFields
            });
        }

        logP(`\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê`, 'ok');
        logP(`‚úÖ COMPLETO: ${allPipes.length} pipes mapeados`, 'ok');
        logP(`‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê`, 'ok');

        pipefyReport = { user: me, orgId, orgName, pipes: allPipes };
        dot.className = 'dot ok';
        btn.textContent = '‚úÖ Conclu√≠do';
        btn.className = 'btn';
        generateReport();

    } catch (err) {
        logP(`\n‚ùå ERRO: ${err.message}`, 'err');
        dot.className = 'dot fail';
        btn.textContent = '‚ùå Erro - Tentar Novamente';
        btn.className = 'btn'; btn.disabled = false;
    }
}

// ===== SIENGE =====
function logS(msg, cls = '') {
    const el = document.getElementById('logSienge');
    el.innerHTML += `<span class="${cls}">${msg}</span>\n`;
    el.scrollTop = el.scrollHeight;
}

async function testEndpoint(path, desc) {
    try {
        const [basePath, queryString] = path.split('?');
        let url = `${PROXY_BASE}?endpoint=${encodeURIComponent(basePath)}`;
        if (queryString) url += '&' + queryString;

        const res = await fetch(url);
        const status = res.status;
        let data = null;
        try { data = await res.json(); } catch { try { data = await res.text(); } catch {} }

        if (status === 200) {
            let count = '?', sample = null;
            if (data) {
                if (data.resultSetMetadata && data.resultSetMetadata.count !== undefined) count = data.resultSetMetadata.count;
                else if (Array.isArray(data)) count = data.length;
                else if (data.results && Array.isArray(data.results)) count = data.results.length;
                if (Array.isArray(data) && data.length > 0) sample = data[0];
                else if (data.results && data.results.length > 0) sample = data.results[0];
                else if (typeof data === 'object' && !data.resultSetMetadata && !data.error) sample = data;
            }
            logS(`‚úÖ ${desc}`, 'ok');
            logS(`   GET ${path} ‚Üí ${status} OK (${count} registros)`, 'ok');
            if (sample) {
                logS(`   Campos: ${Object.keys(sample).join(', ')}`, 'dim');
                const s = JSON.stringify(sample, null, 2);
                logS(`   Amostra: ${s.length < 600 ? s : s.substring(0, 600) + '...'}`, 'dim');
            }
            return { path, desc, status: 'ok', httpStatus: status, count, sample, rawData: data };
        } else if (status === 401) {
            logS(`üîí ${desc}: ‚Üí ${status} CREDENCIAIS INV√ÅLIDAS`, 'err');
            return { path, desc, status: 'auth_error', httpStatus: status };
        } else if (status === 403) {
            logS(`üîí ${desc}: ‚Üí ${status} SEM PERMISS√ÉO`, 'warn');
            return { path, desc, status: 'forbidden', httpStatus: status };
        } else if (status === 404) {
            logS(`‚ùå ${desc}: ‚Üí ${status} N√ÉO ENCONTRADO`, 'err');
            return { path, desc, status: 'not_found', httpStatus: status };
        } else {
            logS(`‚ö†Ô∏è ${desc}: ‚Üí ${status}`, 'warn');
            return { path, desc, status: 'error', httpStatus: status, data };
        }
    } catch (err) {
        logS(`‚ùå ${desc}: ERRO: ${err.message}`, 'err');
        return { path, desc, status: 'error', error: err.message };
    }
}

async function scanSienge() {
    const btn = document.getElementById('btnSienge');
    const dot = document.getElementById('dotSienge');
    btn.disabled = true; btn.className = 'btn running'; btn.textContent = '‚è≥ Escaneando...';
    dot.className = 'dot pending';
    document.getElementById('logSienge').innerHTML = '';

    logS('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'title');
    logS('  ESCANEANDO SIENGE (VIA PROXY)', 'title');
    logS('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'title');
    logS('');

    logS('üîå Testando conex√£o com proxy...', 'info');
    try {
        const t = await fetch(`${PROXY_BASE}?endpoint=/building-projects&limit=1`);
        const tData = await t.json();
        logS(`Proxy respondeu: HTTP ${t.status} - ${JSON.stringify(tData).substring(0, 200)}`, t.status === 200 ? 'ok' : 'warn');
        if (t.status === 401 || (tData && tData.message && tData.message.includes('authentication'))) {
            logS('', '');
            logS('‚ö†Ô∏è CREDENCIAIS DO SIENGE INV√ÅLIDAS!', 'err');
            logS('Verifique no Sienge ‚Üí Painel de Integra√ß√µes:', 'err');
            logS('  ‚Ä¢ Usu√°rio: engefy-dash', 'err');
            logS('  ‚Ä¢ Senha pode ter expirado/mudado', 'err');
            logS('', '');
            logS('O proxy est√° funcionando, mas o Sienge rejeitou as credenciais.', 'warn');
            logS('Atualize a senha no arquivo sienge-proxy.js no GitHub.', 'warn');
            
            siengeReport = { results: [], summary: { ok: 0, authError: true, note: 'Credenciais inv√°lidas' } };
            dot.className = 'dot fail';
            btn.textContent = 'üîí Credenciais inv√°lidas';
            btn.className = 'btn'; btn.disabled = false;
            generateReport();
            return;
        }
    } catch (e) {
        logS(`‚ùå Proxy offline: ${e.message}`, 'err');
        dot.className = 'dot fail';
        btn.textContent = '‚ùå Proxy offline';
        btn.className = 'btn'; btn.disabled = false;
        return;
    }
    logS('');

    const endpoints = [
        { path: '/building-projects?limit=100', desc: 'Obras' },
        { path: '/enterprises?limit=100', desc: 'Empreendimentos' },
        { path: '/budget-categories?limit=50', desc: 'Categorias Or√ßamento' },
        { path: '/budgets?limit=50', desc: 'Or√ßamentos' },
        { path: '/cost-estimates?limit=50', desc: 'Estimativas Custo' },
        { path: '/bills?limit=10', desc: 'Contas a Pagar' },
        { path: '/receivable-bills?limit=10', desc: 'Contas a Receber' },
        { path: '/payments?limit=10', desc: 'Pagamentos' },
        { path: '/receipts?limit=10', desc: 'Recebimentos' },
        { path: '/bank-accounts?limit=50', desc: 'Contas Banc√°rias' },
        { path: '/cost-centers?limit=50', desc: 'Centros de Custo' },
        { path: '/chart-accounts?limit=50', desc: 'Plano de Contas' },
        { path: '/purchase-orders?limit=10', desc: 'Pedidos de Compra' },
        { path: '/purchase-requests?limit=10', desc: 'Solicita√ß√µes de Compra' },
        { path: '/quotations?limit=10', desc: 'Cota√ß√µes' },
        { path: '/suppliers?limit=10', desc: 'Fornecedores' },
        { path: '/contracts?limit=10', desc: 'Contratos' },
        { path: '/measurements?limit=10', desc: 'Medi√ß√µes' },
        { path: '/employees?limit=10', desc: 'Funcion√°rios' },
        { path: '/departments?limit=50', desc: 'Departamentos' },
        { path: '/invoices?limit=10', desc: 'Notas Fiscais' },
        { path: '/service-invoices?limit=10', desc: 'NFs de Servi√ßo' },
        { path: '/units?limit=50', desc: 'Unidades' },
        { path: '/indexes?limit=50', desc: '√çndices' },
        { path: '/document-types?limit=50', desc: 'Tipos de Documento' },
        { path: '/customers?limit=10', desc: 'Clientes' },
        { path: '/creditors?limit=10', desc: 'Credores' },
    ];

    const results = [];
    for (let i = 0; i < endpoints.length; i++) {
        const ep = endpoints[i];
        logS(`[${i + 1}/${endpoints.length}] ${ep.desc}...`, 'info');
        results.push(await testEndpoint(ep.path, ep.desc));
        logS('', '');
        await new Promise(r => setTimeout(r, 300));
    }

    const ok = results.filter(r => r.status === 'ok');
    const auth = results.filter(r => r.status === 'auth_error');
    const forbidden = results.filter(r => r.status === 'forbidden');
    const notFound = results.filter(r => r.status === 'not_found');

    logS('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'title');
    logS(`‚úÖ Acess√≠veis: ${ok.length}`, 'ok');
    logS(`üîí Auth erro: ${auth.length}`, auth.length > 0 ? 'err' : 'dim');
    logS(`üîí Sem permiss√£o: ${forbidden.length}`, forbidden.length > 0 ? 'warn' : 'dim');
    logS(`‚ùå N√£o encontrados: ${notFound.length}`, notFound.length > 0 ? 'err' : 'dim');

    siengeReport = { results, summary: { ok: ok.length, authError: auth.length, forbidden: forbidden.length, notFound: notFound.length } };
    dot.className = ok.length > 0 ? 'dot ok' : 'dot fail';
    btn.textContent = '‚úÖ Conclu√≠do';
    btn.className = 'btn';
    generateReport();
}

// ===== RELAT√ìRIO =====
function generateReport() {
    if (!pipefyReport && !siengeReport) return;
    document.getElementById('reportOutput').style.display = 'block';

    let r = '';
    r += '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n';
    r += '  RELAT√ìRIO DE DESCOBERTA - ENGEFY APIs\n';
    r += `  Gerado em: ${new Date().toLocaleString('pt-BR')}\n`;
    r += '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n';

    if (pipefyReport) {
        r += '‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê\n';
        r += '‚îÇ          PIPEFY - PIPES              ‚îÇ\n';
        r += '‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò\n\n';
        r += `Usu√°rio: ${pipefyReport.user.name} (${pipefyReport.user.email})\n`;
        r += `Organiza√ß√£o: ${pipefyReport.orgName} (ID: ${pipefyReport.orgId})\n`;
        r += `Total de pipes: ${pipefyReport.pipes.length}\n\n`;

        pipefyReport.pipes.forEach(pipe => {
            r += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
            r += `PIPE: "${pipe.name}" [ID: ${pipe.id}]\n`;
            r += `  Cards: ${pipe.cards_count} | Membros: ${pipe.members_count}\n`;
            if (pipe.phases) {
                r += `  FASES:\n`;
                pipe.phases.forEach(p => r += `    ‚Ä¢ ${p.name} (${p.cards_count} cards) [ID: ${p.id}]\n`);
            }
            if (pipe.start_form_fields && pipe.start_form_fields.length > 0) {
                r += `  CAMPOS FORMUL√ÅRIO:\n`;
                pipe.start_form_fields.forEach(f => r += `    ‚Ä¢ "${f.label}" [${f.type}] [ID: ${f.id}]\n`);
            }
            if (pipe._phaseFields) {
                for (const [pname, fields] of Object.entries(pipe._phaseFields)) {
                    r += `  CAMPOS FASE "${pname}":\n`;
                    fields.forEach(f => r += `    ‚Ä¢ "${f.label}" [${f.type}] [ID: ${f.id}]\n`);
                }
            }
            if (pipe._sampleFields && pipe._sampleFields.length > 0) {
                r += `  AMOSTRA VALORES:\n`;
                pipe._sampleFields.forEach(f => {
                    const v = f.value ? (f.value.length > 120 ? f.value.substring(0, 120) + '...' : f.value) : '(vazio)';
                    r += `    ‚Ä¢ "${f.name}" = "${v}"\n`;
                });
            }
            r += '\n';
        });
    }

    if (siengeReport) {
        r += '‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê\n';
        r += '‚îÇ       SIENGE - ENDPOINTS (PROXY)     ‚îÇ\n';
        r += '‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò\n\n';

        if (siengeReport.summary.authError === true) {
            r += '‚ö†Ô∏è CREDENCIAIS INV√ÅLIDAS - Sienge rejeitou autentica√ß√£o\n';
            r += 'Usu√°rio: engefy-dash\n';
            r += 'A√ß√£o: Verificar/atualizar senha no Painel de Integra√ß√µes do Sienge\n\n';
        } else {
            r += `Acess√≠veis: ${siengeReport.summary.ok}\n`;
            r += `Auth erro: ${siengeReport.summary.authError}\n`;
            r += `Sem permiss√£o: ${siengeReport.summary.forbidden}\n`;
            r += `N√£o encontrados: ${siengeReport.summary.notFound}\n\n`;

            const ok = siengeReport.results.filter(r => r.status === 'ok');
            if (ok.length > 0) {
                r += `ENDPOINTS ACESS√çVEIS:\n`;
                ok.forEach(ep => {
                    r += `  ‚úÖ ${ep.desc}: GET ${ep.path} (${ep.count} registros)\n`;
                    if (ep.sample) {
                        r += `     Campos: ${Object.keys(ep.sample).join(', ')}\n`;
                        const s = JSON.stringify(ep.sample);
                        if (s.length < 400) r += `     Amostra: ${s}\n`;
                    }
                });
                r += '\n';
            }

            const forbidden = siengeReport.results.filter(r => r.status === 'forbidden');
            if (forbidden.length > 0) {
                r += `SEM PERMISS√ÉO:\n`;
                forbidden.forEach(ep => r += `  üîí ${ep.desc}: ${ep.path} ‚Üí ${ep.httpStatus}\n`);
                r += '\n';
            }

            const notFound = siengeReport.results.filter(r => r.status === 'not_found');
            if (notFound.length > 0) {
                r += `N√ÉO ENCONTRADOS:\n`;
                notFound.forEach(ep => r += `  ‚ùå ${ep.desc}: ${ep.path}\n`);
                r += '\n';
            }
        }
    }

    r += '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n';
    r += '  FIM DO RELAT√ìRIO\n';
    r += '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n';

    document.getElementById('reportText').textContent = r;
    document.getElementById('reportText').dataset.report = r;
}

function copyReport() {
    const report = document.getElementById('reportText').dataset.report;
    navigator.clipboard.writeText(report).then(() => {
        const btn = document.querySelector('.copy-btn');
        btn.textContent = '‚úÖ COPIADO! Cole na conversa com o Claude';
        setTimeout(() => { btn.textContent = 'üìã COPIAR RELAT√ìRIO COMPLETO'; }, 3000);
    });
}
</script>
</body>
</html>
