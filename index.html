<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Engefy - Descoberta de APIs v3</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&family=Bebas+Neue&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root { --yellow: #FFD23F; --black: #1a1a1a; --dark: #2a2a2a; --medium: #3a3a3a; --light: #e0e0e0; --white: #fff; --green: #00d084; --orange: #ff9500; --red: #ff3b30; --blue: #007aff; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Poppins', sans-serif; background: var(--black); color: var(--white); min-height: 100vh; }
        .header { background: linear-gradient(135deg, var(--dark), var(--medium)); border-bottom: 3px solid var(--yellow); padding: 30px 40px; }
        .header h1 { font-family: 'Bebas Neue', sans-serif; font-size: 2.5rem; color: var(--yellow); letter-spacing: 3px; }
        .header p { color: var(--light); margin-top: 5px; font-size: 0.9rem; }
        .container { max-width: 1200px; margin: 0 auto; padding: 30px 40px; }
        .section { background: var(--dark); border: 2px solid var(--medium); border-radius: 12px; margin-bottom: 25px; overflow: hidden; }
        .section-header { display: flex; justify-content: space-between; align-items: center; padding: 20px 25px; border-bottom: 2px solid var(--medium); background: rgba(255,210,63,0.05); flex-wrap: wrap; gap: 10px; }
        .section-title { font-family: 'Bebas Neue', sans-serif; font-size: 1.5rem; color: var(--yellow); letter-spacing: 2px; }
        .section-body { padding: 20px 25px; }
        .btn { font-family: 'Poppins', sans-serif; padding: 10px 24px; border: 2px solid var(--yellow); background: transparent; color: var(--yellow); border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 0.85rem; transition: all 0.3s; }
        .btn:hover { background: var(--yellow); color: var(--black); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn.running { background: var(--yellow); color: var(--black); animation: pulse 1.5s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
        .log { font-family: 'JetBrains Mono', monospace; font-size: 0.78rem; background: var(--black); border: 1px solid var(--medium); border-radius: 8px; padding: 15px; max-height: 600px; overflow-y: auto; line-height: 1.8; white-space: pre-wrap; word-break: break-all; }
        .log::-webkit-scrollbar { width: 6px; }
        .log::-webkit-scrollbar-thumb { background: var(--yellow); border-radius: 10px; }
        .log .ok { color: var(--green); }
        .log .warn { color: var(--orange); }
        .log .err { color: var(--red); }
        .log .info { color: var(--blue); }
        .log .title { color: var(--yellow); font-weight: 700; font-size: 0.85rem; }
        .log .dim { color: #666; }
        .copy-btn { font-family: 'Poppins', sans-serif; padding: 14px 30px; border: none; background: var(--yellow); color: var(--black); border-radius: 8px; cursor: pointer; font-weight: 700; font-size: 0.95rem; width: 100%; transition: all 0.3s; margin-top: 20px; }
        .copy-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(255,210,63,0.4); }
        .instructions { background: rgba(255,210,63,0.08); border: 1px solid rgba(255,210,63,0.3); border-radius: 8px; padding: 15px 20px; margin-bottom: 20px; font-size: 0.85rem; line-height: 1.7; color: var(--light); }
        .instructions strong { color: var(--yellow); }
        .status-bar { display: flex; gap: 20px; margin-bottom: 20px; flex-wrap: wrap; }
        .status-item { display: flex; align-items: center; gap: 8px; font-size: 0.85rem; }
        .dot { width: 10px; height: 10px; border-radius: 50%; background: var(--medium); }
        .dot.ok { background: var(--green); }
        .dot.fail { background: var(--red); }
        .dot.pending { background: var(--orange); animation: pulse 1.5s infinite; }
        #reportOutput { display: none; }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ” ENGEFY â€” DESCOBERTA DE APIs v3</h1>
        <p>Scan do Pipefy + Sienge via proxy Netlify</p>
    </div>
    <div class="container">
        <div class="instructions">
            <strong>InstruÃ§Ãµes:</strong><br>
            1. Clique em <strong>"Escanear Pipefy"</strong> para mapear todos os pipes<br>
            2. Clique em <strong>"Escanear Sienge"</strong> via proxy<br>
            3. Clique em <strong>"Copiar RelatÃ³rio"</strong> e cole na conversa com o Claude
        </div>
        <div class="status-bar">
            <div class="status-item"><span class="dot" id="dotPipefy"></span><span>Pipefy</span></div>
            <div class="status-item"><span class="dot" id="dotSienge"></span><span>Sienge</span></div>
        </div>
        <div class="section">
            <div class="section-header">
                <span class="section-title">ğŸ“‹ PIPEFY â€” DESCOBERTA DE PIPES</span>
                <button class="btn" id="btnPipefy" onclick="scanPipefy()">â–¶ Escanear Pipefy</button>
            </div>
            <div class="section-body">
                <div class="log" id="logPipefy">Aguardando scan...</div>
            </div>
        </div>
        <div class="section">
            <div class="section-header">
                <span class="section-title">ğŸ—ï¸ SIENGE â€” DESCOBERTA VIA PROXY</span>
                <button class="btn" id="btnSienge" onclick="scanSienge()">â–¶ Escanear Sienge</button>
            </div>
            <div class="section-body">
                <div class="log" id="logSienge">Aguardando scan...</div>
            </div>
        </div>
        <div id="reportOutput" class="section">
            <div class="section-header">
                <span class="section-title">ğŸ“„ RELATÃ“RIO PARA O CLAUDE</span>
            </div>
            <div class="section-body">
                <div class="log" id="reportText" style="max-height: 400px;"></div>
                <button class="copy-btn" onclick="copyReport()">ğŸ“‹ COPIAR RELATÃ“RIO COMPLETO</button>
            </div>
        </div>
    </div>

<script>
const PIPEFY_TOKEN = 'eyJhbGciOiJIUzUxMiJ9.eyJpc3MiOiJQaXBlZnkiLCJpYXQiOjE3NzA4MTY5OTYsImp0aSI6ImUyZWVlMjUxLTgzYzItNGU3ZC04OTFkLTBkZDZhNzM1ZjJhZCIsInN1YiI6MjQxNzA4LCJ1c2VyIjp7ImlkIjoyNDE3MDgsImVtYWlsIjoibHVhbm1hbm5lc0Bjb25zdHJ1dG9yYWVuZ2VmeS5jb20uYnIifSwidXNlcl90eXBlIjoiYXV0aGVudGljYXRlZCJ9.hSHH8ph-26_kViEdMZrrKj7tPrEvioADVdATYuFo0c_nb3ffD8G-luzd0luiAvDkPBQolawdS009s2PCVBpHcw';
const PROXY_BASE = '/.netlify/functions/sienge-proxy';
let pipefyReport = null;
let siengeReport = null;

function logP(msg, cls = '') {
    const el = document.getElementById('logPipefy');
    el.innerHTML += `<span class="${cls}">${msg}</span>\n`;
    el.scrollTop = el.scrollHeight;
}

async function gql(query) {
    const res = await fetch('https://api.pipefy.com/graphql', {
        method: 'POST',
        headers: { 'Authorization': `Bearer ${PIPEFY_TOKEN}`, 'Content-Type': 'application/json' },
        body: JSON.stringify({ query })
    });
    return await res.json();
}

async function scanPipefy() {
    const btn = document.getElementById('btnPipefy');
    const dot = document.getElementById('dotPipefy');
    btn.disabled = true; btn.className = 'btn running'; btn.textContent = 'â³ Escaneando...';
    dot.className = 'dot pending';
    document.getElementById('logPipefy').innerHTML = '';

    try {
        logP('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'title');
        logP('  ESCANEANDO PIPEFY', 'title');
        logP('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'title');
        logP('');

        logP('ğŸ”‘ Consultando usuÃ¡rio...', 'info');
        const meData = await gql(`{ me { id name email } }`);
        if (meData.errors) throw new Error(JSON.stringify(meData.errors));
        const me = meData.data.me;
        logP(`âœ… ${me.name} (${me.email})`, 'ok');

        logP('\\nğŸ” Descobrindo organizaÃ§Ã£o via pipe 734128...', 'info');
        const pipeOrgData = await gql(`{ pipe(id: 734128) { id name organization { id name } } }`);
        if (pipeOrgData.errors) throw new Error(JSON.stringify(pipeOrgData.errors));
        const orgId = pipeOrgData.data.pipe.organization.id;
        const orgName = pipeOrgData.data.pipe.organization.name;
        logP(`âœ… OrganizaÃ§Ã£o: ${orgName} (ID: ${orgId})`, 'ok');

        logP('\\nğŸ“‹ Buscando todos os pipes...', 'info');
        const orgData = await gql(`{
            organization(id: ${orgId}) {
                pipes {
                    id
                    name
                    cards_count
                    phases { id name cards_count }
                    start_form_fields { id label type }
                }
            }
        }`);

        if (orgData.errors) throw new Error(JSON.stringify(orgData.errors));
        const pipes = orgData.data.organization.pipes;
        logP(`âœ… ${pipes.length} pipes encontrados!`, 'ok');

        const allPipes = [];

        for (const pipe of pipes) {
            logP(`\\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€`, 'dim');
            logP(`ğŸ“Œ "${pipe.name}" [ID: ${pipe.id}]`, 'title');
            logP(`   Cards: ${pipe.cards_count}`, '');

            if (pipe.phases && pipe.phases.length > 0) {
                logP(`   ğŸ“‚ Fases:`, '');
                pipe.phases.forEach(p => logP(`      â€¢ ${p.name} (${p.cards_count} cards) [${p.id}]`, 'dim'));
            }

            if (pipe.start_form_fields && pipe.start_form_fields.length > 0) {
                logP(`   ğŸ“ Campos FormulÃ¡rio:`, '');
                pipe.start_form_fields.forEach(f => logP(`      â€¢ "${f.label}" [${f.type}] [${f.id}]`, 'dim'));
            }

            let phaseFields = {};
            let sampleFields = [];

            try {
                const detail = await gql(`{
                    pipe(id: ${pipe.id}) {
                        phases {
                            name
                            fields { id label type }
                            cards(first: 1) {
                                edges {
                                    node {
                                        title
                                        fields { name value field { id } }
                                    }
                                }
                            }
                        }
                    }
                }`);

                if (detail.data && detail.data.pipe) {
                    detail.data.pipe.phases.forEach(phase => {
                        if (phase.fields && phase.fields.length > 0) {
                            phaseFields[phase.name] = phase.fields;
                        }
                        if (phase.cards && phase.cards.edges.length > 0) {
                            phase.cards.edges[0].node.fields.forEach(f => {
                                if (!sampleFields.find(sf => sf.name === f.name)) {
                                    sampleFields.push(f);
                                }
                            });
                        }
                    });

                    for (const [pname, fields] of Object.entries(phaseFields)) {
                        logP(`   ğŸ·ï¸ Campos fase "${pname}":`, '');
                        fields.forEach(f => logP(`      â€¢ "${f.label}" [${f.type}] [${f.id}]`, 'dim'));
                    }

                    if (sampleFields.length > 0) {
                        logP(`   ğŸ“Š Amostra (1Âº card):`, '');
                        sampleFields.forEach(f => {
                            const v = f.value ? (f.value.length > 80 ? f.value.substring(0, 80) + '...' : f.value) : '(vazio)';
                            logP(`      â€¢ "${f.name}" = "${v}"`, 'dim');
                        });
                    }
                }
            } catch (e) {
                logP(`   âš ï¸ Erro detalhes: ${e.message}`, 'warn');
            }

            allPipes.push({
                id: pipe.id, name: pipe.name,
                cards_count: pipe.cards_count,
                phases: pipe.phases,
                start_form_fields: pipe.start_form_fields,
                _phaseFields: phaseFields,
                _sampleFields: sampleFields
            });
        }

        logP(`\\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•`, 'ok');
        logP(`âœ… COMPLETO: ${allPipes.length} pipes mapeados`, 'ok');
        logP(`â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•`, 'ok');

        pipefyReport = { user: me, orgId, orgName, pipes: allPipes };
        dot.className = 'dot ok';
        btn.textContent = 'âœ… ConcluÃ­do';
        btn.className = 'btn';
        generateReport();

    } catch (err) {
        logP(`\\nâŒ ERRO: ${err.message}`, 'err');
        dot.className = 'dot fail';
        btn.textContent = 'âŒ Erro - Tentar Novamente';
        btn.className = 'btn'; btn.disabled = false;
    }
}

function logS(msg, cls = '') {
    const el = document.getElementById('logSienge');
    el.innerHTML += `<span class="${cls}">${msg}</span>\n`;
    el.scrollTop = el.scrollHeight;
}

async function testEndpoint(path, desc) {
    try {
        const [basePath, queryString] = path.split('?');
        let url = `${PROXY_BASE}?endpoint=${encodeURIComponent(basePath)}`;
        if (queryString) url += '&' + queryString;

        const res = await fetch(url);
        const status = res.status;
        let data = null;
        try { data = await res.json(); } catch { try { data = await res.text(); } catch {} }

        if (status === 200) {
            let count = '?', sample = null;
            if (data) {
                if (data.resultSetMetadata && data.resultSetMetadata.count !== undefined) count = data.resultSetMetadata.count;
                else if (Array.isArray(data)) count = data.length;
                else if (data.results && Array.isArray(data.results)) count = data.results.length;
                if (Array.isArray(data) && data.length > 0) sample = data[0];
                else if (data.results && data.results.length > 0) sample = data.results[0];
                else if (typeof data === 'object' && !data.resultSetMetadata && !data.error) sample = data;
            }
            logS(`âœ… ${desc}`, 'ok');
            logS(`   GET ${path} â†’ ${status} (${count} registros)`, 'ok');
            if (sample) {
                logS(`   Campos: ${Object.keys(sample).join(', ')}`, 'dim');
                const s = JSON.stringify(sample, null, 2);
                logS(`   Amostra: ${s.length < 600 ? s : s.substring(0, 600) + '...'}`, 'dim');
            }
            return { path, desc, status: 'ok', httpStatus: status, count, sample, rawData: data };
        } else if (status === 401) {
            logS(`ğŸ”’ ${desc}: â†’ ${status} CREDENCIAIS INVÃLIDAS`, 'err');
            return { path, desc, status: 'auth_error', httpStatus: status };
        } else if (status === 403) {
            logS(`ğŸ”’ ${desc}: â†’ ${status} SEM PERMISSÃƒO`, 'warn');
            return { path, desc, status: 'forbidden', httpStatus: status };
        } else if (status === 404) {
            logS(`âŒ ${desc}: â†’ ${status} NÃƒO ENCONTRADO`, 'err');
            return { path, desc, status: 'not_found', httpStatus: status };
        } else {
            logS(`âš ï¸ ${desc}: â†’ ${status}`, 'warn');
            return { path, desc, status: 'error', httpStatus: status, data };
        }
    } catch (err) {
        logS(`âŒ ${desc}: ERRO: ${err.message}`, 'err');
        return { path, desc, status: 'error', error: err.message };
    }
}

async function scanSienge() {
    const btn = document.getElementById('btnSienge');
    const dot = document.getElementById('dotSienge');
    btn.disabled = true; btn.className = 'btn running'; btn.textContent = 'â³ Escaneando...';
    dot.className = 'dot pending';
    document.getElementById('logSienge').innerHTML = '';

    logS('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'title');
    logS('  ESCANEANDO SIENGE (VIA PROXY)', 'title');
    logS('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'title');
    logS('');

    logS('ğŸ”Œ Testando conexÃ£o...', 'info');
    try {
        const t = await fetch(`${PROXY_BASE}?endpoint=/building-projects&limit=1`);
        const tData = await t.json();
        logS(`Proxy: HTTP ${t.status} - ${JSON.stringify(tData).substring(0, 200)}`, t.status === 200 ? 'ok' : 'warn');
        if (t.status === 401 || (tData && tData.message && tData.message.includes('authentication'))) {
            logS('\\nâš ï¸ CREDENCIAIS DO SIENGE INVÃLIDAS!', 'err');
            logS('Verifique no Sienge â†’ Painel de IntegraÃ§Ãµes', 'err');
            logS('Atualize a senha no sienge-proxy.js no GitHub', 'warn');
            siengeReport = { results: [], summary: { ok: 0, authError: true } };
            dot.className = 'dot fail';
            btn.textContent = 'ğŸ”’ Credenciais invÃ¡lidas';
            btn.className = 'btn'; btn.disabled = false;
            generateReport();
            return;
        }
    } catch (e) {
        logS(`âŒ Proxy offline: ${e.message}`, 'err');
        dot.className = 'dot fail';
        btn.textContent = 'âŒ Proxy offline';
        btn.className = 'btn'; btn.disabled = false;
        return;
    }
    logS('');

    const endpoints = [
        { path: '/building-projects?limit=100', desc: 'Obras' },
        { path: '/enterprises?limit=100', desc: 'Empreendimentos' },
        { path: '/budget-categories?limit=50', desc: 'Categorias OrÃ§amento' },
        { path: '/budgets?limit=50', desc: 'OrÃ§amentos' },
        { path: '/cost-estimates?limit=50', desc: 'Estimativas Custo' },
        { path: '/bills?limit=10', desc: 'Contas a Pagar' },
        { path: '/receivable-bills?limit=10', desc: 'Contas a Receber' },
        { path: '/payments?limit=10', desc: 'Pagamentos' },
        { path: '/receipts?limit=10', desc: 'Recebimentos' },
        { path: '/bank-accounts?limit=50', desc: 'Contas BancÃ¡rias' },
        { path: '/cost-centers?limit=50', desc: 'Centros de Custo' },
        { path: '/chart-accounts?limit=50', desc: 'Plano de Contas' },
        { path: '/purchase-orders?limit=10', desc: 'Pedidos de Compra' },
        { path: '/purchase-requests?limit=10', desc: 'SolicitaÃ§Ãµes de Compra' },
        { path: '/quotations?limit=10', desc: 'CotaÃ§Ãµes' },
        { path: '/suppliers?limit=10', desc: 'Fornecedores' },
        { path: '/contracts?limit=10', desc: 'Contratos' },
        { path: '/measurements?limit=10', desc: 'MediÃ§Ãµes' },
        { path: '/employees?limit=10', desc: 'FuncionÃ¡rios' },
        { path: '/departments?limit=50', desc: 'Departamentos' },
        { path: '/invoices?limit=10', desc: 'Notas Fiscais' },
        { path: '/service-invoices?limit=10', desc: 'NFs de ServiÃ§o' },
        { path: '/units?limit=50', desc: 'Unidades' },
        { path: '/customers?limit=10', desc: 'Clientes' },
        { path: '/creditors?limit=10', desc: 'Credores' },
    ];

    const results = [];
    for (let i = 0; i < endpoints.length; i++) {
        const ep = endpoints[i];
        logS(`[${i + 1}/${endpoints.length}] ${ep.desc}...`, 'info');
        results.push(await testEndpoint(ep.path, ep.desc));
        logS('', '');
        await new Promise(r => setTimeout(r, 300));
    }

    const ok = results.filter(r => r.status === 'ok');
    const auth = results.filter(r => r.status === 'auth_error');
    const forbidden = results.filter(r => r.status === 'forbidden');
    const notFound = results.filter(r => r.status === 'not_found');

    logS('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'title');
    logS(`âœ… AcessÃ­veis: ${ok.length}`, 'ok');
    logS(`ğŸ”’ Auth erro: ${auth.length}`, auth.length > 0 ? 'err' : 'dim');
    logS(`ğŸ”’ Sem permissÃ£o: ${forbidden.length}`, forbidden.length > 0 ? 'warn' : 'dim');
    logS(`âŒ NÃ£o encontrados: ${notFound.length}`, notFound.length > 0 ? 'err' : 'dim');

    siengeReport = { results, summary: { ok: ok.length, authError: auth.length, forbidden: forbidden.length, notFound: notFound.length } };
    dot.className = ok.length > 0 ? 'dot ok' : 'dot fail';
    btn.textContent = 'âœ… ConcluÃ­do';
    btn.className = 'btn';
    generateReport();
}

function generateReport() {
    if (!pipefyReport && !siengeReport) return;
    document.getElementById('reportOutput').style.display = 'block';

    let r = '';
    r += 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\\n';
    r += '  RELATÃ“RIO DE DESCOBERTA - ENGEFY APIs\\n';
    r += '  Gerado em: ' + new Date().toLocaleString('pt-BR') + '\\n';
    r += 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\\n\\n';

    if (pipefyReport) {
        r += 'â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\\n';
        r += 'â”‚          PIPEFY - PIPES              â”‚\\n';
        r += 'â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\\n\\n';
        r += 'UsuÃ¡rio: ' + pipefyReport.user.name + ' (' + pipefyReport.user.email + ')\\n';
        r += 'OrganizaÃ§Ã£o: ' + pipefyReport.orgName + ' (ID: ' + pipefyReport.orgId + ')\\n';
        r += 'Total de pipes: ' + pipefyReport.pipes.length + '\\n\\n';

        pipefyReport.pipes.forEach(function(pipe) {
            r += 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\n';
            r += 'PIPE: "' + pipe.name + '" [ID: ' + pipe.id + ']\\n';
            r += '  Cards: ' + pipe.cards_count + '\\n';
            if (pipe.phases) {
                r += '  FASES:\\n';
                pipe.phases.forEach(function(p) { r += '    â€¢ ' + p.name + ' (' + p.cards_count + ' cards) [ID: ' + p.id + ']\\n'; });
            }
            if (pipe.start_form_fields && pipe.start_form_fields.length > 0) {
                r += '  CAMPOS FORMULÃRIO:\\n';
                pipe.start_form_fields.forEach(function(f) { r += '    â€¢ "' + f.label + '" [' + f.type + '] [ID: ' + f.id + ']\\n'; });
            }
            if (pipe._phaseFields) {
                for (var pname in pipe._phaseFields) {
                    r += '  CAMPOS FASE "' + pname + '":\\n';
                    pipe._phaseFields[pname].forEach(function(f) { r += '    â€¢ "' + f.label + '" [' + f.type + '] [ID: ' + f.id + ']\\n'; });
                }
            }
            if (pipe._sampleFields && pipe._sampleFields.length > 0) {
                r += '  AMOSTRA VALORES:\\n';
                pipe._sampleFields.forEach(function(f) {
                    var v = f.value ? (f.value.length > 120 ? f.value.substring(0, 120) + '...' : f.value) : '(vazio)';
                    r += '    â€¢ "' + f.name + '" = "' + v + '"\\n';
                });
            }
            r += '\\n';
        });
    }

    if (siengeReport) {
        r += 'â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\\n';
        r += 'â”‚       SIENGE - ENDPOINTS (PROXY)     â”‚\\n';
        r += 'â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\\n\\n';

        if (siengeReport.summary.authError === true) {
            r += 'âš ï¸ CREDENCIAIS INVÃLIDAS\\n\\n';
        } else {
            r += 'AcessÃ­veis: ' + siengeReport.summary.ok + '\\n';
            r += 'Auth erro: ' + siengeReport.summary.authError + '\\n';
            r += 'Sem permissÃ£o: ' + siengeReport.summary.forbidden + '\\n';
            r += 'NÃ£o encontrados: ' + siengeReport.summary.notFound + '\\n\\n';

            var ok = siengeReport.results.filter(function(r) { return r.status === 'ok'; });
            if (ok.length > 0) {
                r += 'ENDPOINTS ACESSÃVEIS:\\n';
                ok.forEach(function(ep) {
                    r += '  âœ… ' + ep.desc + ': GET ' + ep.path + ' (' + ep.count + ' registros)\\n';
                    if (ep.sample) {
                        r += '     Campos: ' + Object.keys(ep.sample).join(', ') + '\\n';
                        var s = JSON.stringify(ep.sample);
                        if (s.length < 400) r += '     Amostra: ' + s + '\\n';
                    }
                });
                r += '\\n';
            }

            var forbidden = siengeReport.results.filter(function(r) { return r.status === 'forbidden'; });
            if (forbidden.length > 0) {
                r += 'SEM PERMISSÃƒO:\\n';
                forbidden.forEach(function(ep) { r += '  ğŸ”’ ' + ep.desc + ': ' + ep.path + ' â†’ ' + ep.httpStatus + '\\n'; });
                r += '\\n';
            }

            var notFound = siengeReport.results.filter(function(r) { return r.status === 'not_found'; });
            if (notFound.length > 0) {
                r += 'NÃƒO ENCONTRADOS:\\n';
                notFound.forEach(function(ep) { r += '  âŒ ' + ep.desc + ': ' + ep.path + '\\n'; });
                r += '\\n';
            }
        }
    }

    r += 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\\n';
    r += '  FIM DO RELATÃ“RIO\\n';
    r += 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\\n';

    document.getElementById('reportText').textContent = r;
    document.getElementById('reportText').dataset.report = r;
}

function copyReport() {
    var report = document.getElementById('reportText').dataset.report;
    navigator.clipboard.writeText(report).then(function() {
        var btn = document.querySelector('.copy-btn');
        btn.textContent = 'âœ… COPIADO! Cole na conversa com o Claude';
        setTimeout(function() { btn.textContent = 'ğŸ“‹ COPIAR RELATÃ“RIO COMPLETO'; }, 3000);
    });
}
</script>
</body>
</html>
